<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="cordinc">
    <title>Multiple Attachments with Validations In Rails with Paperclip</title>
    <link href="/assets/css/bootstrap.css" rel="stylesheet">
    <link href="/assets/css/cordinc.css" rel="stylesheet">
    <link href="/assets/css/pygments/default.css" rel="stylesheet">
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">Cordinc</a>
        <div class="nav-collapse collapse">
          <ul class="nav navbar-nav">
            <li class=""><a href="/about.html">About</a></li>
            <li class=""><a href="/projects">Projects</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">

       <div class="cordinc-content">
            <div class="row">
<div class="col-lg-8">
<b>April 12, 2009</b>
<h4>Multiple Attachments with Validations In Rails with Paperclip</h4>
Tags: 
    
      <a class="post" href="/blog/tag/Rails.html">Rails</a>, 
    
      <a class="post" href="/blog/tag/Ruby.html">Ruby</a>, 
    
      <a class="post" href="/blog/tag/Technical.html">Technical</a>
    
<br/><br/>
<p>I wanted a project to allow attachments to be added to tasks. My
requirements were that: users should be able to add multiple attachments
to a task up to some maximum limit; there should be validation on the
size of the attachments (combined with the number limit this should
ensure I don’t run out of disk space too fast); and, that there should
be some security on downloading a task’s attachments.
<a href="http://www.thoughtbot.com/projects/paperclip/">Paperclip</a> seems to be
the popular Rails attachment at the moment and is still under active
development, so I hoped to use that. However, it does not handle
multiple attachments for a model. There is a plugin
<a href="http://github.com/heavysixer/paperclippolymorph/tree/master">PaperclipPolymorph</a>
which adds multiple attachments to Paperclip, but I just couldn’t get it
to meet my validation and security requirements. In the end I wrote my
own solution and this article details it.</p>

<!--more-->

<p><strong>Update:</strong> This tutorial was completed using Rails 2.1.0, since then
there have been a few changes, see the first comment (by Flyc) below. If
you are using Rails 2.3+ you will at a minimum need to rename
app/controller/appilication.rb to
apps/controller/application_controller.rb</p>

<p>Firstly, if you don’t need multiple attachments, take a look at the
<a href="http://www.thoughtbot.com/projects/paperclip/">Paperclip documentation</a>
and <a href="http://thewebfellas.com/blog/2008/11/2/goodbye-attachment_fu-hello-paperclip">this webfellas
article</a>
and you should be fine. Also, if you just need multiple attachments
without any of the extra stuff, then PaperclipPolymorph will probably
meet your needs. Lastly, I found <a href="http://www.practicalecommerce.com/blogs/post/432-Multiple-Attachments-in-Rails">this article by Brian
Getting</a>
detailing how to handle multiple attachments with <a href="http://github.com/technoweenie/attachment_fu/tree/master">Attachment
Fu</a> (a
Paperclip alternative). My tutorial closely follows his as I used it as
a base for my investigations.</p>

<p>To demonstrate how I met my requirements I will use the example of
creating a simple Rails app with a single model class, task, and allow
that class to handle multiple attachments. You can download this project
<a href="/projects/attachments.zip">here</a>.</p>

<p><strong>Step 1 : Create the project</strong></p>

<p>Here I just create a very simple Rails project called <code class="highlighter-rouge">attachments</code> with
a single model class <code class="highlighter-rouge">Task</code> which contains only title and body
attributes. Then I install Paperclip using Git. As I don’t need any of
the image based functionality in Paperclip I haven’t installed any of
its associated images packages, see the documentation if you think you
might need them.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">rails <span class="nt">-d</span> attachments
ruby script/generate scaffold Task title:string body:text
ruby script/plugin <span class="nb">install </span>git://github.com/thoughtbot/paperclip.git</code></pre></figure>

<p><strong>Step 2: Add the attachments model</strong></p>

<p>Below is the migration I used to create a table for storing the
associations between model objects and their attachments. I have made it
polymorphic so it can be used with other model classes. It is called
<code class="highlighter-rouge">Assets</code> as if it is called <code class="highlighter-rouge">Attachments</code> there is an error in some
versions of Rails. Use <t>rake db:migrate&lt;/tt&gt; to create the tables.</t></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Assets</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">create_table</span> <span class="ss">:assets</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:data_file_name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:data_content_type</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:data_file_size</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:attachable_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:attachable_type</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:assets</span><span class="p">,</span> <span class="p">[</span><span class="ss">:attachable_id</span><span class="p">,</span> <span class="ss">:attachable_type</span><span class="p">]</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">drop_table</span> <span class="ss">:assets</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Then create the attachments model class in <code class="highlighter-rouge">asset.rb</code>. This class has a
few handy shortcut methods to get access to attachment information and a
polymorphic association to the actual attachment <code class="highlighter-rouge">data</code>.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Asset</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_attached_file</span> <span class="ss">:data</span><span class="p">,</span>

  <span class="n">belongs_to</span> <span class="ss">:attachable</span><span class="p">,</span> <span class="ss">:polymorphic</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  
  <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">data</span><span class="p">.</span><span class="nf">url</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">name</span>
    <span class="n">data_file_name</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">content_type</span>
    <span class="n">data_content_type</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">file_size</span>
    <span class="n">data_file_size</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>To have a standard multiple attachments model like is seen in <a href="http://www.practicalecommerce.com/blogs/post/432-Multiple-Attachments-in-Rails">Brian
Getting</a>
article and PaperclipPolymorph we just need to add an association to the
<code class="highlighter-rouge">Task</code> model. In <code class="highlighter-rouge">task.rb</code> add the line:
<code class="highlighter-rouge">has_many  :assets, :as =&gt; :attachable, :dependent =&gt; :destroy</code>.</p>

<p><strong>Step 3: Add Validations</strong></p>

<p>To ensure that there are never more than 5 attachments on a <code class="highlighter-rouge">Task</code> and
that each attachment is less than a megabyte, add the following lines to
<code class="highlighter-rouge">task.rb</code>. Putting validations on the <code class="highlighter-rouge">Task</code> model allows the <code class="highlighter-rouge">Asset</code>
model to be reused by other classes if they need multiple attachments.
These limits can obviously be easily modified by changing the constants.
You will see these constants used throughout the rest of the project, so
that the control and display of validations is in a single place.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">validate</span> <span class="ss">:validate_attachments</span>
  
  <span class="no">Max_Attachments</span> <span class="o">=</span> <span class="mi">5</span>
  <span class="no">Max_Attachment_Size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="nf">megabyte</span>

  <span class="k">def</span> <span class="nf">validate_attachments</span>
    <span class="n">errors</span><span class="p">.</span><span class="nf">add_to_base</span><span class="p">(</span><span class="s2">"Too many attachments - maximum is </span><span class="si">#{</span><span class="no">Max_Attachments</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">assets</span><span class="p">.</span><span class="nf">length</span> <span class="o">&gt;</span> <span class="no">Max_Attachments</span>
    <span class="n">assets</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">errors</span><span class="p">.</span><span class="nf">add_to_base</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">a</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2"> is over </span><span class="si">#{</span><span class="no">Max_Attachment_Size</span><span class="o">/</span><span class="mi">1</span><span class="p">.</span><span class="nf">megabyte</span><span class="si">}</span><span class="s2">MB"</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span><span class="p">.</span><span class="nf">file_size</span> <span class="o">&gt;</span> <span class="no">Max_Attachment_Size</span><span class="p">}</span>
  <span class="k">end</span></code></pre></figure>

<p><strong>Step 4: Add Security</strong></p>

<p>By default Paperclip stores attachments under the <code class="highlighter-rouge">public</code> directory,
thus they are generally available to everyone. To secure the attachments
Paperclip needs to be told to store the attachments in a different
place, and provided with a controller method to retrieve them. To store
the attachments in an <code class="highlighter-rouge">assets</code> directory directly under the project
root, and have the <code class="highlighter-rouge">show</code> method on the <code class="highlighter-rouge">AssetsController</code> retrieve
them, then modify the association in <code class="highlighter-rouge">asset.rb</code> to be the following:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="n">has_attached_file</span> <span class="ss">:data</span><span class="p">,</span>
                    <span class="ss">:url</span>  <span class="o">=&gt;</span> <span class="s2">"/assets/:id"</span><span class="p">,</span>
                    <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">":rails_root/assets/docs/:id/:style/:basename.:extension"</span></code></pre></figure>

<p>This will require the creation of <code class="highlighter-rouge">assets_controller.rb</code> as below. I
have just put the comment <code class="highlighter-rouge"># do security check here</code> in the method where
you need to add any security checking as it tends to be application
specific. Likely security includes checking the user is logged in or has
a particular role or has permission to view the object which has the
attachment.</p>

<p><strong>Update:</strong> if you are using a web server that handles it, you can add
<code class="highlighter-rouge">:x_sendfile =&gt; true</code> on the end of the <code class="highlighter-rouge">send_file</code> to lower memory
consumption. See the <a href="http://api.rubyonrails.org/classes/ActionController/Streaming.html">Rails documentation for more
information</a>.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">AssetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  
  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">asset</span> <span class="o">=</span> <span class="no">Asset</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="c1"># do security check here</span>
    <span class="n">send_file</span> <span class="n">asset</span><span class="p">.</span><span class="nf">data</span><span class="p">.</span><span class="nf">path</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="n">asset</span><span class="p">.</span><span class="nf">data_content_type</span>
  <span class="k">end</span>
    
<span class="k">end</span></code></pre></figure>

<p><strong>Step 5: Setup Display</strong></p>

<p>To handle the display for this simple app there is a <code class="highlighter-rouge">new</code> page that
allows users to add attachments to a task, a <code class="highlighter-rouge">show</code> page that displays
the attachments for task and an <code class="highlighter-rouge">edit</code> page that allows both. To do this
some javascript needs to be set up. Also the rest of this tutorial
assumes that the image <code class="highlighter-rouge">public/images/attachment.png</code> is present and
that the css includes the following (I just added it to
<code class="highlighter-rouge">public/stylesheets/scaffold.css</code>):</p>

<figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nf">#attachment_list</span> <span class="nf">#pending_files</span><span class="p">{</span> <span class="nl">list-style</span><span class="p">:</span><span class="nb">none</span><span class="p">;</span><span class="nl">padding</span><span class="p">:</span><span class="m">0</span><span class="p">;</span> <span class="p">}</span>
<span class="nf">#attachment_list</span> <span class="nt">li</span> <span class="p">{</span> <span class="nl">padding</span><span class="p">:</span><span class="m">0</span> <span class="m">0</span> <span class="m">0.5em</span> <span class="m">21px</span><span class="p">;</span><span class="nl">background</span><span class="p">:</span><span class="sx">url('/images/attachment.png')</span> <span class="nb">no-repeat</span> <span class="m">0</span> <span class="m">2px</span><span class="p">;</span> <span class="p">}</span>
<span class="nf">#attachment_list</span> <span class="nt">li</span> <span class="nf">#remove</span> <span class="p">{</span> <span class="nl">margin-left</span><span class="p">:</span><span class="m">1em</span><span class="p">;</span> <span class="p">}</span></code></pre></figure>

<p>I have used a slightly modified version of the multifile javascript
library used by <a href="http://www.practicalecommerce.com/blogs/post/432-Multiple-Attachments-in-Rails">Brian
Getting</a>
and originally by the
<a href="http://the-stickman.com/web-development/javascript/upload-multiple-files-with-a-single-file-element/">Stickman</a>.
This assumes you are using <a href="http://www.prototypejs.org/">Prototype</a> and
<a href="http://script.aculo.us/">Scriptaculous</a>. It allows users to add a
number of files at once which are then stored in page and sent on an
update. Create the file <code class="highlighter-rouge">public/javascripts/multifile.js</code> as below:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// -------------------------</span>
<span class="c1">// Multiple File Upload</span>
<span class="c1">// -------------------------</span>
<span class="kd">function</span> <span class="nx">MultiSelector</span><span class="p">(</span><span class="nx">list_target</span><span class="p">,</span> <span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">list_target</span> <span class="o">=</span> <span class="nx">list_target</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="k">if</span><span class="p">(</span> <span class="nx">max</span> <span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="nx">max</span><span class="p">;}</span> <span class="k">else</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;};</span><span class="k">this</span><span class="p">.</span><span class="nx">addElement</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">element</span> <span class="p">){</span><span class="k">if</span><span class="p">(</span> <span class="nx">element</span><span class="p">.</span><span class="nx">tagName</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">INPUT</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span> <span class="p">){</span><span class="nx">element</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">attachment[file_</span><span class="dl">'</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="o">++</span><span class="p">)</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">]</span><span class="dl">'</span><span class="p">;</span><span class="nx">element</span><span class="p">.</span><span class="nx">multi_selector</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span><span class="nx">element</span><span class="p">.</span><span class="nx">onchange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">new_element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span> <span class="dl">'</span><span class="s1">input</span><span class="dl">'</span> <span class="p">);</span><span class="nx">new_element</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span> <span class="nx">new_element</span><span class="p">,</span> <span class="k">this</span> <span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">multi_selector</span><span class="p">.</span><span class="nx">addElement</span><span class="p">(</span> <span class="nx">new_element</span> <span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">multi_selector</span><span class="p">.</span><span class="nx">addListRow</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">absolute</span><span class="dl">'</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">-1000px</span><span class="dl">'</span><span class="p">;};</span><span class="k">if</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">max</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">count</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">max</span> <span class="p">){</span><span class="nx">element</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;};</span><span class="k">this</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">current_element</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;}</span> <span class="k">else</span> <span class="p">{</span><span class="nx">alert</span><span class="p">(</span> <span class="dl">'</span><span class="s1">Error: not a file input element</span><span class="dl">'</span> <span class="p">);};};</span><span class="k">this</span><span class="p">.</span><span class="nx">addListRow</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">element</span> <span class="p">){</span><span class="kd">var</span> <span class="nx">new_row</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">li</span><span class="dl">'</span><span class="p">);</span><span class="kd">var</span> <span class="nx">new_row_button</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span> <span class="dl">'</span><span class="s1">a</span><span class="dl">'</span> <span class="p">);</span><span class="nx">new_row_button</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">id</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">remove</span><span class="dl">'</span><span class="p">);</span><span class="nx">new_row_button</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Remove This Attachment</span><span class="dl">'</span><span class="p">;</span><span class="nx">new_row_button</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">#</span><span class="dl">'</span><span class="p">;</span><span class="nx">new_row_button</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Remove</span><span class="dl">'</span><span class="p">;</span><span class="nx">new_row</span><span class="p">.</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span><span class="nx">new_row_button</span><span class="p">.</span><span class="nx">onclick</span><span class="o">=</span> <span class="kd">function</span><span class="p">(){</span><span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">element</span> <span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span> <span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">multi_selector</span><span class="p">.</span><span class="nx">count</span><span class="o">--</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">multi_selector</span><span class="p">.</span><span class="nx">current_element</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span><span class="k">return</span> <span class="kc">false</span><span class="p">;};</span><span class="nx">new_row</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)[</span><span class="nx">element</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">).</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span><span class="nx">new_row</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span> <span class="nx">new_row_button</span> <span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">list_target</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span> <span class="nx">new_row</span> <span class="p">);};</span>
<span class="p">}</span></code></pre></figure>

<p>Then just add the javascript into the page layout for any page that will
require the ability to upload files (lazily, I put it in
<code class="highlighter-rouge">layouts/tasks.html.erb</code> despite not all task views needing it).</p>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span>  <span class="s2">"prototype"</span><span class="p">,</span> <span class="s2">"application"</span><span class="p">,</span>  <span class="s2">"effects"</span><span class="p">,</span> <span class="s2">"controls"</span><span class="p">,</span> <span class="s2">"multifile"</span> <span class="cp">%&gt;</span></code></pre></figure>

<p><strong>Step 6: New Action</strong></p>

<p>Firstly, to add new attachments to the scaffold <code class="highlighter-rouge">new.html.erb</code> the form
needs to be updated to include <code class="highlighter-rouge">:multipart =&gt; true</code>, this allows the
attachments to be sent along with the HTTP request. Then the
<code class="highlighter-rouge">Pending Attachment</code> paragraph creates the input field and
<code class="highlighter-rouge">MultiSelector</code> from <code class="highlighter-rouge">multifile.js</code> handles attachment upload on submit.
The empty <code class="highlighter-rouge">pending_files</code> will contain references to the attachments.
Note the use of the <code class="highlighter-rouge">Task</code> constants for the allowable number and size
of the attachments.</p>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="nt">&lt;h1&gt;</span>New task<span class="nt">&lt;/h1&gt;</span>
<span class="cp">&lt;%</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@task</span><span class="p">,</span> <span class="ss">:html</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:multipart</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">error_messages</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:title</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:title</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:body</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_area</span> <span class="ss">:body</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>Pending Attachments: (Max of <span class="cp">&lt;%=</span> <span class="no">Task</span><span class="o">::</span><span class="no">Max_Attachments</span> <span class="cp">%&gt;</span> each under <span class="cp">&lt;%=</span> <span class="no">Task</span><span class="o">::</span><span class="no">Max_Attachment_Size</span><span class="o">/</span><span class="mi">1</span><span class="p">.</span><span class="nf">megabyte</span><span class="cp">%&gt;</span>MB)
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@task</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">count</span> <span class="o">&gt;=</span> <span class="no">Task</span><span class="o">::</span><span class="no">Max_Attachments</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"newfile_data"</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">disabled</span> <span class="nt">/&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"newfile_data"</span> <span class="na">type=</span><span class="s">"file"</span> <span class="nt">/&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"attachment_list"</span><span class="nt">&gt;&lt;ul</span> <span class="na">id=</span><span class="s">"pending_files"</span><span class="nt">&gt;&lt;/ul&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
          <span class="kd">var</span> <span class="nx">multi_selector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MultiSelector</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">pending_files</span><span class="dl">'</span><span class="p">),</span> <span class="cp">&lt;%=</span><span class="no">Task</span><span class="o">::</span><span class="no">Max_Attachment_Size</span><span class="cp">%&gt;</span><span class="p">);</span>
          <span class="nx">multi_selector</span><span class="p">.</span><span class="nx">addElement</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">newfile_data</span><span class="dl">'</span><span class="p">));</span>
      <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Create"</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Back'</span><span class="p">,</span> <span class="n">tasks_path</span> <span class="cp">%&gt;</span></code></pre></figure>

<p>In the controller the attachments need to be read in and added to the
new task. The below code script needs to be added into
<code class="highlighter-rouge">app/controllers/tasks_controller.rb</code>. Here most of the work is
offloaded to the protected <code class="highlighter-rouge">process_file_uploads</code> method, so it can be
reused in other methods. Before the save or update of a task which may
have attachments added to it, call <code class="highlighter-rouge">process_file_uploads</code> which just
loops through the HTTP parameters and builds any given attachments. They
will then be validated and persisted to the database with a save or
update.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="c1"># POST /tasks</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@task</span> <span class="o">=</span> <span class="no">Task</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:task</span><span class="p">])</span>
    
    <span class="n">process_file_uploads</span><span class="p">(</span><span class="vi">@task</span><span class="p">)</span>

    <span class="k">if</span> <span class="vi">@task</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Task was successfully created.'</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="vi">@task</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="s2">"new"</span> 
    <span class="k">end</span>
  <span class="k">end</span>
  
  <span class="kp">protected</span>

  <span class="k">def</span> <span class="nf">process_file_uploads</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
      <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">while</span> <span class="n">params</span><span class="p">[</span><span class="ss">:attachment</span><span class="p">][</span><span class="s1">'file_'</span><span class="o">+</span><span class="n">i</span><span class="p">.</span><span class="nf">to_s</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">""</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">params</span><span class="p">[</span><span class="ss">:attachment</span><span class="p">][</span><span class="s1">'file_'</span><span class="o">+</span><span class="n">i</span><span class="p">.</span><span class="nf">to_s</span><span class="p">].</span><span class="nf">nil?</span>
          <span class="n">task</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">:data</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="p">[</span><span class="ss">:attachment</span><span class="p">][</span><span class="s1">'file_'</span><span class="o">+</span><span class="n">i</span><span class="p">.</span><span class="nf">to_s</span><span class="p">])</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">end</span>
  <span class="k">end</span></code></pre></figure>

<p><strong>Step 7: Show Action</strong></p>

<p>The show action is a little different - it doesn’t allow any attachments
to be added, instead just displaying a list of the current task
attachments. Below in <code class="highlighter-rouge">app/views/tasks/show.html.erb</code> this is done with
a partial.</p>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="nt">&lt;p&gt;</span>
  <span class="nt">&lt;b&gt;</span>Title:<span class="nt">&lt;/b&gt;</span>
  <span class="cp">&lt;%=</span><span class="n">h</span> <span class="vi">@task</span><span class="p">.</span><span class="nf">title</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;p&gt;</span>
  <span class="nt">&lt;b&gt;</span>Body:<span class="nt">&lt;/b&gt;</span>
  <span class="cp">&lt;%=</span><span class="n">h</span> <span class="vi">@task</span><span class="p">.</span><span class="nf">body</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;&lt;b&gt;</span>Attached Files:<span class="nt">&lt;/b&gt;&lt;div</span> <span class="na">id=</span><span class="s">"attachment_list"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s2">"attachment"</span><span class="p">,</span> <span class="ss">:collection</span> <span class="o">=&gt;</span> <span class="vi">@task</span><span class="p">.</span><span class="nf">assets</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;&lt;/p&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Edit'</span><span class="p">,</span> <span class="n">edit_task_path</span><span class="p">(</span><span class="vi">@task</span><span class="p">)</span> <span class="cp">%&gt;</span> | <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Back'</span><span class="p">,</span> <span class="n">tasks_path</span> <span class="cp">%&gt;</span></code></pre></figure>

<p>The partial <code class="highlighter-rouge">app/views/tasks/_attachment.html.erb</code> just displays some
basic information about the attachment, including a link for it to be
downloaded using <code class="highlighter-rouge">attachment.url</code>. Remember from Step 4 that this will
return the url of the <code class="highlighter-rouge">AssetsController</code>’s <code class="highlighter-rouge">show</code> method to add a layer
of security. I have left the remove link in the partial, this will be
explained in the next step.</p>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="cp">&lt;%</span> <span class="k">if</span> <span class="o">!</span><span class="n">attachment</span><span class="p">.</span><span class="nf">id</span><span class="p">.</span><span class="nf">nil?</span> <span class="cp">%&gt;</span><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">'attachment_</span><span class="cp">&lt;%=</span><span class="n">attachment</span><span class="p">.</span><span class="nf">id</span> <span class="cp">%&gt;</span><span class="s">'</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">'</span><span class="cp">&lt;%=</span><span class="n">attachment</span><span class="p">.</span><span class="nf">url</span> <span class="cp">%&gt;</span><span class="s">'</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span><span class="n">attachment</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/a&gt;</span> (<span class="cp">&lt;%=</span><span class="n">attachment</span><span class="p">.</span><span class="nf">file_size</span><span class="o">/</span><span class="mi">1</span><span class="p">.</span><span class="nf">kilobyte</span> <span class="cp">%&gt;</span>KB)
<span class="cp">&lt;%=</span> <span class="n">link_to_remote</span> <span class="s2">"Remove"</span><span class="p">,</span> <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">asset_path</span><span class="p">(</span><span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">attachment</span><span class="p">),</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:html</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:title</span>  <span class="o">=&gt;</span> <span class="s2">"Remove this attachment"</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s2">"remove"</span> <span class="p">}</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span></code></pre></figure>

<p><strong>Step 8: Removing Attachments</strong></p>

<p>The <code class="highlighter-rouge">_attachment.html.erb</code> partial included a link to remove the
attachment. This requires the following <code class="highlighter-rouge">destroy</code> method added to the
<code class="highlighter-rouge">assets_controller.rb</code>. It simply finds the attachment and deletes it.
The page is updated through javascript returned to the user’s browser.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">asset</span> <span class="o">=</span> <span class="no">Asset</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="vi">@asset_id</span> <span class="o">=</span> <span class="n">asset</span><span class="p">.</span><span class="nf">id</span><span class="p">.</span><span class="nf">to_s</span>
    <span class="vi">@allowed</span> <span class="o">=</span> <span class="no">Task</span><span class="o">::</span><span class="no">Max_Attachments</span> <span class="o">-</span> <span class="n">asset</span><span class="p">.</span><span class="nf">attachable</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">count</span> 
    <span class="n">asset</span><span class="p">.</span><span class="nf">destroy</span>
  <span class="k">end</span></code></pre></figure>

<p>The <code class="highlighter-rouge">destroy</code> method’s view is <code class="highlighter-rouge">app/views/assets/destroy.rjs</code> which
using javascript finds the attachment deleted and removes it from the
page. It then checks for an attachment add section (by looking for a
<code class="highlighter-rouge">newfile_data</code> id) and if it finds one updates the number of attachments
that may still be added. With this check the RJS can still be used
without error on pages that do not have a <code class="highlighter-rouge">newfile_data</code> input nor a
<code class="highlighter-rouge">MultiSelector</code>.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">page</span><span class="p">.</span><span class="nf">hide</span> <span class="s2">"attachment_</span><span class="si">#{</span><span class="vi">@asset_id</span><span class="si">}</span><span class="s2">"</span>
<span class="n">page</span><span class="p">.</span><span class="nf">remove</span> <span class="s2">"attachment_</span><span class="si">#{</span><span class="vi">@asset_id</span><span class="si">}</span><span class="s2">"</span>

<span class="c1"># check that a newfile_data id exists</span>
<span class="n">page</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s1">'newfile_data'</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">element</span><span class="o">|</span> 
  <span class="n">page</span><span class="p">.</span><span class="nf">assign</span> <span class="s1">'multi_selector.max'</span><span class="p">,</span> <span class="vi">@allowed</span>
  <span class="k">if</span> <span class="vi">@allowed</span> <span class="o">&lt;</span> <span class="no">Task</span><span class="o">::</span><span class="no">Max_Attachments</span>
    <span class="n">page</span> <span class="o">&lt;&lt;</span> <span class="s2">"if ($('newfile_data').disabled) { $('newfile_data').disabled = false };"</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p><strong>Step 9: Edit Action</strong></p>

<p>To complete the views, here is the <code class="highlighter-rouge">edit.html.erb</code> which combines the
attachment adding functionality of <code class="highlighter-rouge">new</code> with the attachment list of
<code class="highlighter-rouge">show</code>.</p>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="nt">&lt;h1&gt;</span>Editing task<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@task</span><span class="p">,</span> <span class="ss">:html</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:multipart</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">error_messages</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:title</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:title</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:body</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">text_area</span> <span class="ss">:body</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>Pending Attachments: (Max of <span class="cp">&lt;%=</span> <span class="no">Task</span><span class="o">::</span><span class="no">Max_Attachments</span> <span class="cp">%&gt;</span> each under <span class="cp">&lt;%=</span> <span class="no">Task</span><span class="o">::</span><span class="no">Max_Attachment_Size</span><span class="o">/</span><span class="mi">1</span><span class="p">.</span><span class="nf">megabyte</span><span class="cp">%&gt;</span>MB)
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@task</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">count</span> <span class="o">&gt;=</span> <span class="no">Task</span><span class="o">::</span><span class="no">Max_Attachments</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"newfile_data"</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">disabled</span> <span class="nt">/&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"newfile_data"</span> <span class="na">type=</span><span class="s">"file"</span> <span class="nt">/&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"attachment_list"</span><span class="nt">&gt;&lt;ul</span> <span class="na">id=</span><span class="s">"pending_files"</span><span class="nt">&gt;&lt;/ul&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
          <span class="kd">var</span> <span class="nx">multi_selector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MultiSelector</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">pending_files</span><span class="dl">'</span><span class="p">),</span> <span class="cp">&lt;%=</span> <span class="vi">@allowed</span> <span class="cp">%&gt;</span><span class="p">);</span>
          <span class="nx">multi_selector</span><span class="p">.</span><span class="nx">addElement</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">newfile_data</span><span class="dl">'</span><span class="p">));</span>
      <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    Attached Files:<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"attachment_list"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s2">"attachment"</span><span class="p">,</span> <span class="ss">:collection</span> <span class="o">=&gt;</span> <span class="vi">@task</span><span class="p">.</span><span class="nf">assets</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Update"</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Show'</span><span class="p">,</span> <span class="vi">@task</span> <span class="cp">%&gt;</span> | <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">'Back'</span><span class="p">,</span> <span class="n">tasks_path</span> <span class="cp">%&gt;</span></code></pre></figure>

<p><strong>Step 10: Ta-da!</strong></p>

<p>And that completes the tutorial. You should now have a working task list
with multiple attachments. My version of the app can be downloaded
<a href="http://www.cordinc.com/projects/attachments.zip">here</a> for comparison
or as a base.</p>

<hr />

<p><strong>Comments:</strong>
<em>I have removed the commenting system (for privacy concerns), below are the comments that were left on this post before doing so…</em></p>

<p><em>Flyc @ 2010-01-21</em> - Hi Charles, Thanks for taking the time to post this article. Exactly what I needed and got the job done. Few points: 1. When I got to step 6, creating the action and specifically process_file_uploads and realized that the recently added feature of accepts_nested_attributes_for would make this easier to code. Please can you comment. Here’s an excellent tutorial from ryanb on this</p>

<p><em>Charles @ 2010-01-22</em> - Hi Flyc, You are quite right. This tutorial was created using Rails 2.1.0 (I should specify this in post itself) and since then there have been a few improvements. In Rails 2.3.0 the application controller was renamed  (see <a href="http://guides.rubyonrails.org/2_3_release_notes.html#application-controller-renamed)." rel="nofollow noopener" title="http://guides.rubyonrails.org/2_3_release_notes.html#application-controller-renamed).">http://guides.rubyonrails.org/2_3_release_notes.html#application-controller-renamed</a>). So people using versions later than 2.3 will need to rename it like you did. I didn’t previously know about accepts_nested_attributes_for, but that is a good little tutorial - thanks for pointing it out. I will have to investigate. Thanks, Charles.</p>

<p><em>davemlynch @ 2010-01-22</em> - Hi Charles, Great post, pointed me right direction for muiltple file uploads with paperclip. Just one question when i was trying out your code, I tried recalling an image with code below &lt;% @photo = Asset.find_by_attachable_id(@task.id)%&gt; &lt;%if !@photo.blank? %&gt; &lt;%= image_tag (@photo.data.url(:small))%&gt; I was getting &lt;img src=”/assets/4/?1266410329” alt”?1266410329”&gt; in html code. I was expecting to get &lt;img src=”/assets/4/small.jpg” alt”“&gt; Any help would be gratefull</p>

<p><em>Charles @ 2010-01-22</em> - Hi Dave,&lt; I’m guessing the problem you are having with &lt;%= image_tag (@photo.data.url(:small))%&gt; is that the image isn’t showing because the url is wrong (at least that’s the problem I had trying out your example). This is because of the security added as part of step 4. Remember that by default Paperclip stores its attachments in the public folder, but the tutorial changed this with: has_attached_file :data, :url  =&gt; “/assets/:id”, :path =&gt; “:rails_root/assets/docs/:id/:style/:basename.:extension”. This means that the attachments are stored in a non-public accessible place and all access to them goes through the AssetsController (which currently doesn’t know about styles and can’t stream back images). The easiest solution to your problem is to disable security and make the attachments publically available. This can be done by changing the above line in assert.rb to: has_attached_file :data, :style =&gt; { :small =&gt; “100x100” } Note all your previous loaded attachments are now in the wrong place and won’t work - you will need to remove them first and load them again (a restart will probably help too - it did for me). If you still need security then the issue is much harder to fix. Firstly the has_attached_file line’s url will need to know about styles. It will become something like :url =&gt; “/assets/:id/:style”. Then when you create the image tag the style will be included, like &lt;img src=”/assets/4/small”&gt;. This still calls the AssetsController, so the routes will have to be updated so that style is passed through to the show method. Lastly, <a href="http://AssetsController.show" rel="nofollow noopener" title="AssetsController.show">AssetsController.show</a> will have to be modified to take in the :style, get the appropriate attachment and then stream it back to the caller. Note at the moment it uses send_file to allow the caller to download the attachment. If you also wanted to display some attachments this would have to change to handle displaying the image vs downloading. Not sure how to do that last bit. If security is not vital then just try removing it.Good luck, Charles.</p>

<p><em>Jussi @ 2010-02-28</em> - I tested your application. Everything worked fine since I tried to download a stored file attachment (pdf, jpg). I can download the file, but it’s always empty and damaged. I mean that size is not original and file cannot be opened. I checked that the file was stored successfully in the folder asset/docs/’id’/original. Any ideas how to solve the problem? If I disable security and store files to public folder, everything works fine.</p>

<p><em>Charles @ 2010-03-01</em> - Hi Jussi, I think I have worked out the issue. It seems my web server is one that can handle the &gt;:x_sendfile =&gt; true option. If I disable that ability on the web server, then I get the error you describe (disabling security bypasses send_file). Try changing the send_file line in AssetsController.rb to send_file asset.data.path, :type =&gt; asset.data_content_type (ie. removing x_sendfile). For more info check out the send_file documentation at <a href="http://api.rubyonrails.org/classes/ActionController/Streaming.html." rel="nofollow noopener" title="http://api.rubyonrails.org/classes/ActionController/Streaming.html.">http://api.rubyonrails.org/classes/ActionController/Streaming.html.</a> Thanks for spotting this. I have updated this post and example project.</p>

<p><em>Headline Shirts @ 2010-05-17</em> - Thanks for this tutorial, I had errors when there were no attachments so I added this to the process_file_uploads method</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">process_file_uploads</span><span class="p">(</span><span class="n">design</span><span class="p">)</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:attachment</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">params</span><span class="p">[</span><span class="ss">:attachment</span><span class="p">][</span><span class="s1">'file_'</span><span class="o">+</span><span class="n">i</span><span class="p">.</span><span class="nf">to_s</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">""</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">params</span><span class="p">[</span><span class="ss">:attachment</span><span class="p">][</span><span class="s1">'file_'</span><span class="o">+</span><span class="n">i</span><span class="p">.</span><span class="nf">to_s</span><span class="p">].</span><span class="nf">nil?</span>
      <span class="n">task</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">:data</span> <span class="o">=&gt;</span><span class="p">;</span> <span class="n">params</span><span class="p">[</span><span class="ss">:attachment</span><span class="p">][</span><span class="s1">'file_'</span><span class="o">+</span><span class="n">i</span><span class="p">.</span><span class="nf">to_s</span><span class="p">])</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>but then I got real and I wanted to make sure there was at least one attachment and that it was a pdf so in tag.rb, the Tag Model, i added some more validations:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">validate_attachments</span>
  <span class="o">...</span>
  <span class="c1">## require minimum of one attachment</span>
  <span class="n">errors</span><span class="p">.</span><span class="nf">add_to_base</span><span class="p">(</span><span class="s2">"Min. one attachment"</span><span class="p">)</span> <span class="k">if</span> <span class="n">assets</span><span class="p">.</span><span class="nf">length</span> <span class="o">&lt;</span> <span class="mi">1</span>
  <span class="c1">## require file to be a pdf with reasonable accuracy</span>
 <span class="n">assets</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">errors</span><span class="p">.</span><span class="nf">add_to_base</span><span class="p">(</span><span class="s1">'#{a.name} is not a Pdf'</span><span class="p">)</span> <span class="k">unless</span> <span class="n">a</span><span class="p">.</span><span class="nf">content_type</span> <span class="o">=~</span> <span class="sr">/pdf/</span> <span class="p">}</span>
<span class="k">end</span></code></pre></figure>

<p>thanks again for the tutorial</p>

</div>

<div class="col-lg-2">
<br/>

<small>
<a href="/blog/archives.html">Full Archives</a>

<br/><br/>

Recent Posts:
<ul class="list-unstyled">
  
  <li>  
    <a href="/blog/2023/02/goals.html">Goals</a> 
  </li>  
  
  <li>  
    <a href="/blog/2022/12/release.html">Release</a> 
  </li>  
  
  <li>  
    <a href="/blog/2022/10/back-again-gaming.html">Back Again Gaming</a> 
  </li>  
  
  <li>  
    <a href="/blog/2022/09/hosting.html">Hosting</a> 
  </li>  
  
  <li>  
    <a href="/blog/2022/08/roguelike.html">Roguelike Tutorial 2022</a> 
  </li>  
  
  <li>  
    <a href="/blog/2022/06/brisbane.html">Brisbane</a> 
  </li>  
  
  <li>  
    <a href="/blog/2022/06/ipod.html">iPod</a> 
  </li>  
  
  <li>  
    <a href="/blog/2022/04/esperance.html">Esperance (and places along the way)</a> 
  </li>  
  
  <li>  
    <a href="/blog/2022/04/real-dreams.html">Real Dreams</a> 
  </li>  
  
  <li>  
    <a href="/blog/2022/04/ai-hot-take.html">AI Hot Take</a> 
  </li>  

</ul>

<br/><br/>

Top Tags: <ul class="list-unstyled"><li><a href="/blog/tag/Technical.html">Technical</a></li> <li><a href="/blog/tag/A%20Gamedev%20Plays.html">A Gamedev Plays</a></li> <li><a href="/blog/tag/Games.html">Games</a></li> <li><a href="/blog/tag/Travel.html">Travel</a></li> <li><a href="/blog/tag/History.html">History</a></li> <li><a href="/blog/tag/Podcasts.html">Podcasts</a></li> <li><a href="/blog/tag/General.html">General</a></li> <li><a href="/blog/tag/Memories.html">Memories</a></li> <li><a href="/blog/tag/Video%20Games.html">Video Games</a></li> <li><a href="/blog/tag/Finance.html">Finance</a></li> <li><a href="/blog/tag/Projects.html">Projects</a></li> <li><a href="/blog/tag/Meta.html">Meta</a></li> <li><a href="/blog/tag/Malaysia.html">Malaysia</a></li> <li><a href="/blog/tag/Java.html">Java</a></li> <li><a href="/blog/tag/Goals.html">Goals</a></li></ul>

</small>
</div>

<div class="col-lg-2">
</div>
</div>

       </div>

    </div><!-- /.container -->

  </body>
</html>
